<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat P2P Descentralizado</title>
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      #chat {
        width: 300px;
        height: 400px;
        border: 1px solid #ccc;
        padding: 10px;
        overflow-y: scroll;
      }
      #message {
        width: 80%;
      }
      #send {
        width: 15%;
      }
    </style>
  </head>
  <body>
    <div>
      <input type="text" id="username" placeholder="Seu nome" />
      <input type="text" id="peer" placeholder="IP do peer" />
      <button id="connect">Conectar</button>
    </div>
    <div id="chat"></div>
    <input type="text" id="message" />
    <button id="send">Enviar</button>

    <script>
      const signalingServer = new WebSocket('ws://localhost:6789');
      let localConnection;
      let dataChannel;
      let username;

      signalingServer.onmessage = (message) => {
        const data = JSON.parse(message.data);
        if (data.type === 'offer') {
          localConnection.setRemoteDescription(new RTCSessionDescription(data));
          localConnection.createAnswer().then((answer) => {
            localConnection.setLocalDescription(answer);
            signalingServer.send(
              JSON.stringify({
                action: 'signal',
                to: data.from,
                data: { type: 'answer', answer: answer },
              }),
            );
          });
        } else if (data.type === 'answer') {
          localConnection.setRemoteDescription(
            new RTCSessionDescription(data.answer),
          );
        } else if (data.type === 'candidate') {
          localConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      };

      document.getElementById('connect').onclick = () => {
        username = document.getElementById('username').value;
        const peer = document.getElementById('peer').value;
        signalingServer.send(
          JSON.stringify({ action: 'register', username: username }),
        );

        localConnection = new RTCPeerConnection();
        dataChannel = localConnection.createDataChannel('chat');

        dataChannel.onmessage = (event) => {
          const chat = document.getElementById('chat');
          chat.innerHTML += `<p>${event.data}</p>`;
          chat.scrollTop = chat.scrollHeight;
        };

        localConnection.onicecandidate = (event) => {
          if (event.candidate) {
            signalingServer.send(
              JSON.stringify({
                action: 'signal',
                to: peer,
                data: { type: 'candidate', candidate: event.candidate },
              }),
            );
          }
        };

        if (peer) {
          localConnection.createOffer().then((offer) => {
            localConnection.setLocalDescription(offer);
            signalingServer.send(
              JSON.stringify({
                action: 'signal',
                to: peer,
                data: { type: 'offer', offer: offer },
              }),
            );
          });
        }
      };

      document.getElementById('send').onclick = () => {
        const message = document.getElementById('message').value;
        dataChannel.send(message);
        document.getElementById('message').value = '';
      };
    </script>
  </body>
</html>
